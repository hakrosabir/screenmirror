<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ScreenMirror Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: sans-serif; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        .anim-pulse-slow { animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4 bg-gradient-to-br from-slate-900 to-slate-800">

    <!-- HEADER -->
    <div class="absolute top-6 left-0 right-0 text-center opacity-50">
        <h1 class="text-xl font-bold tracking-wider"><i class="fa-solid fa-tower-broadcast mr-2"></i>SCREEN MIRROR</h1>
    </div>

    <!-- 1. HOME SCREEN (Select Mode) -->
    <div id="menu-panel" class="glass p-8 rounded-2xl shadow-2xl max-w-md w-full text-center transition-all duration-500">
        <h2 class="text-2xl font-bold mb-2 text-white">Select Device Role</h2>
        <p class="text-slate-400 mb-8 text-sm">Mirror your phone screen to this device</p>

        <div class="grid grid-cols-1 gap-4">
            <!-- Button to act as RECEIVER (PC/TV) -->
            <button onclick="initReceiver()" class="group relative p-6 rounded-xl bg-blue-600 hover:bg-blue-500 transition-all text-white shadow-lg hover:shadow-blue-500/25">
                <div class="flex items-center justify-center gap-4">
                    <i class="fa-solid fa-desktop text-3xl"></i>
                    <div class="text-left">
                        <div class="font-bold text-lg">Receive Screen</div>
                        <div class="text-blue-200 text-xs">Use this on PC, Laptop, or TV</div>
                    </div>
                </div>
            </button>

            <!-- Button to act as SENDER (Phone) - Manual Option -->
            <button onclick="showManualConnect()" class="p-4 rounded-xl bg-slate-700 hover:bg-slate-600 transition-all text-slate-300 border border-slate-600">
                <i class="fa-solid fa-mobile-screen mr-2"></i> I want to share this screen
            </button>
        </div>
    </div>

    <!-- 2. RECEIVER UI (PC: Shows QR & Video) -->
    <div id="receiver-panel" class="hidden w-full max-w-6xl flex flex-col items-center">
        
        <!-- WAITING STATE: Show QR Code -->
        <div id="receiver-waiting" class="glass p-10 rounded-3xl text-center max-w-lg w-full shadow-2xl border-2 border-blue-500/30 relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-blue-500 via-purple-500 to-blue-500 anim-pulse-slow"></div>
            
            <h3 class="text-2xl font-bold text-white mb-2">Scan to Connect</h3>
            <p class="text-slate-400 mb-6">Open your phone's camera and scan this code</p>
            
            <div class="bg-white p-4 rounded-xl inline-block shadow-inner mb-6">
                <div id="qrcode"></div>
            </div>

            <div class="text-xs text-slate-500 font-mono bg-slate-900/50 p-2 rounded">
                ID: <span id="display-id" class="text-blue-400 font-bold text-lg select-all">Generating...</span>
            </div>
            
            <div class="mt-6 flex items-center justify-center gap-2 text-xs text-slate-500">
                <div class="w-2 h-2 bg-green-500 rounded-full animate-ping"></div>
                Waiting for connection...
            </div>
            
            <button onclick="location.reload()" class="mt-8 text-slate-500 hover:text-white text-sm underline">Cancel</button>
        </div>

        <!-- CONNECTED STATE: Video Player -->
        <div id="video-container" class="hidden w-full flex flex-col items-center">
            <div class="w-full bg-black rounded-xl shadow-2xl overflow-hidden border border-slate-700 relative aspect-video max-h-[85vh]">
                <video id="remote-video" autoplay playsinline class="w-full h-full object-contain"></video>
                <div id="video-overlay" class="absolute bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-black/80 to-transparent opacity-0 hover:opacity-100 transition-opacity flex justify-between items-center">
                    <span class="text-white font-mono text-sm"><i class="fa-solid fa-circle text-red-500 text-[10px] mr-2 animate-pulse"></i>LIVE</span>
                    <button onclick="toggleFullScreen()" class="text-white hover:text-blue-400"><i class="fa-solid fa-expand"></i> Fullscreen</button>
                </div>
            </div>
            <button onclick="location.reload()" class="mt-4 px-6 py-2 bg-slate-800 hover:bg-red-500/20 text-slate-300 hover:text-red-400 rounded-full transition-colors border border-slate-700">
                <i class="fa-solid fa-power-off mr-2"></i> Stop Mirroring
            </button>
        </div>
    </div>

    <!-- 3. SENDER UI (Phone: Start Sharing) -->
    <div id="sender-panel" class="hidden glass p-8 rounded-2xl shadow-2xl max-w-sm w-full text-center">
        <div class="w-16 h-16 bg-blue-600 rounded-full flex items-center justify-center mx-auto mb-6 shadow-lg shadow-blue-500/50">
            <i class="fa-solid fa-tower-broadcast text-2xl text-white"></i>
        </div>
        
        <h2 class="text-2xl font-bold text-white mb-2">Ready to Mirror</h2>
        <p class="text-slate-400 mb-8 text-sm">Cast your screen to the connected device.</p>

        <div id="connection-status" class="hidden mb-4 text-yellow-400 text-sm animate-pulse">
            Connecting to receiver...
        </div>

        <!-- Screen Share Button -->
        <button id="start-share-btn" onclick="startSharing('screen')" class="w-full py-4 bg-green-600 hover:bg-green-500 text-white font-bold rounded-xl shadow-lg hover:shadow-green-500/30 transition-all transform hover:-translate-y-1 mb-3">
            <i class="fa-solid fa-mobile-screen mr-2"></i> Share Screen
        </button>

        <!-- Camera Share Button (Fallback) -->
        <button id="start-cam-btn" onclick="startSharing('camera')" class="w-full py-3 bg-slate-700 hover:bg-slate-600 text-white font-semibold rounded-xl shadow border border-slate-600 transition-all mb-3">
            <i class="fa-solid fa-camera mr-2"></i> Share Camera Only
        </button>
        
        <button onclick="location.href=window.location.pathname" class="text-slate-500 text-sm mt-4">Cancel</button>
    </div>

    <!-- 4. MANUAL CONNECT (Fallback) -->
    <div id="manual-panel" class="hidden glass p-8 rounded-2xl max-w-sm w-full text-center">
        <h3 class="text-lg font-bold mb-4">Enter ID from PC</h3>
        <input type="text" id="manual-id-input" placeholder="e.g. AB123" class="w-full bg-slate-900 border border-slate-700 p-3 rounded-lg text-center text-white text-lg font-mono uppercase mb-4 focus:border-blue-500 outline-none">
        <button onclick="connectToId(document.getElementById('manual-id-input').value)" class="w-full py-3 bg-blue-600 rounded-lg text-white font-bold">Connect</button>
        <button onclick="location.reload()" class="mt-4 text-slate-500 text-sm">Back</button>
    </div>

    <script>
        // --- CONFIGURATION ---
        const peerConfig = { debug: 1 }; 

        // --- STATE ---
        let peer = null;
        let targetPeerId = null;

        // --- INITIALIZATION ---
        window.onload = () => {
            const urlParams = new URLSearchParams(window.location.search);
            const refId = urlParams.get('ref');
            if (refId) {
                showPanel('sender-panel');
                targetPeerId = refId;
            } else {
                showPanel('menu-panel');
            }
        };

        // --- RECEIVER LOGIC (PC) ---
        function initReceiver() {
            showPanel('receiver-panel');
            const myId = generateId();
            document.getElementById('display-id').innerText = myId;

            const fullUrl = `${window.location.origin}${window.location.pathname}?ref=${myId}`;
            new QRCode(document.getElementById("qrcode"), {
                text: fullUrl, width: 180, height: 180,
                colorDark : "#000000", colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });

            peer = new Peer(myId, peerConfig);
            
            peer.on('call', (call) => {
                document.getElementById('receiver-waiting').classList.add('hidden');
                document.getElementById('video-container').classList.remove('hidden');
                call.answer();
                call.on('stream', (remoteStream) => {
                    const video = document.getElementById('remote-video');
                    video.srcObject = remoteStream;
                });
                call.on('close', () => location.reload());
            });
            
            peer.on('error', err => alert("Connection Error: " + err.type));
        }

        // --- SENDER LOGIC (Phone) ---
        function showManualConnect() { showPanel('manual-panel'); }

        function connectToId(id) {
            if(!id) return alert("Enter ID");
            targetPeerId = id.trim();
            showPanel('sender-panel');
        }

        async function startSharing(mode) {
            const btn = document.getElementById(mode === 'screen' ? 'start-share-btn' : 'start-cam-btn');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Initializing...';

            try {
                peer = new Peer(generateId(), peerConfig);
                await new Promise(resolve => peer.on('open', resolve));

                let stream = null;

                if (mode === 'screen') {
                    // Check for screen support
                    if (!navigator.mediaDevices || !navigator.mediaDevices.getDisplayMedia) {
                        // FALLBACK LOGIC
                        if(confirm("Your phone browser does not support Screen Sharing. Switch to Camera Sharing instead?")) {
                            mode = 'camera'; // switch mode
                        } else {
                            throw new Error("Screen sharing not supported.");
                        }
                    }
                }

                // Get Media Stream based on Mode (may have switched to camera above)
                if (mode === 'screen') {
                    stream = await navigator.mediaDevices.getDisplayMedia({
                        video: { cursor: "always", frameRate: 30 },
                        audio: false 
                    });
                } else {
                    // Camera Mode
                    stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } },
                        audio: true
                    });
                }

                // Call Receiver
                const call = peer.call(targetPeerId, stream);

                // UI Update
                btn.classList.replace('bg-green-600', 'bg-red-600');
                btn.classList.replace('bg-slate-700', 'bg-red-600');
                btn.innerHTML = '<i class="fa-solid fa-stop"></i> Stop Sharing';
                
                // Cleanup function
                const stopSharing = () => {
                    stream.getTracks().forEach(track => track.stop());
                    location.href = window.location.pathname;
                };

                btn.onclick = stopSharing;
                stream.getVideoTracks()[0].onended = stopSharing;

            } catch (err) {
                console.error(err);
                alert("Error: " + err.message + "\n\nTry using the 'Share Camera' button if Screen Share fails.");
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        // --- UTILS ---
        function showPanel(id) {
            ['menu-panel', 'receiver-panel', 'sender-panel', 'manual-panel'].forEach(p => {
                document.getElementById(p).classList.add('hidden');
            });
            document.getElementById(id).classList.remove('hidden');
        }

        function generateId() {
            return Math.floor(Math.random()*16777215).toString(16).slice(0,4).toUpperCase();
        }

        function toggleFullScreen() {
            if (!document.fullscreenElement) document.documentElement.requestFullscreen();
            else if (document.exitFullscreen) document.exitFullscreen();
        }
    </script>
</body>
</html>
