<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pro Group Call</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PeerJS -->
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { background-color: #0f172a; color: #fff; font-family: system-ui, -apple-system, sans-serif; overflow: hidden; height: 100vh; height: 100dvh; margin: 0; }
        
        /* --- ROBUST GRID LAYOUT --- */
        #video-grid {
            display: grid;
            width: 100%;
            height: 100%;
            padding: 10px;
            padding-bottom: 120px; /* Space for controls */
            gap: 10px;
            overflow-y: auto; /* Enable scrolling */
            align-content: start;
            
            /* DEFAULT (Mobile): Force 2 columns */
            grid-template-columns: repeat(2, 1fr);
            grid-auto-rows: min-content; /* Prevent huge empty rows */
        }

        /* DESKTOP: Adaptive columns */
        @media (min-width: 768px) {
            #video-grid {
                padding: 20px;
                gap: 16px;
                grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
                align-content: center;
            }
        }

        /* --- VIDEO CARD --- */
        .video-card {
            position: relative;
            background: #1e293b;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            aspect-ratio: 1; /* Square on mobile for better fit */
            width: 100%;
            border: 3px solid transparent;
            transition: transform 0.2s;
        }

        @media (min-width: 640px) {
            .video-card { aspect-ratio: 16/9; } /* Wide on larger screens */
        }

        /* Only child expands */
        .video-card:only-child {
            grid-column: 1 / -1;
            aspect-ratio: auto;
            height: 100%;
            max-height: 80vh;
        }
        
        .video-card video {
            width: 100%; height: 100%;
            object-fit: cover;
            background: #000;
        }

        /* AVATAR OVERLAY (Camera Off) */
        .avatar-overlay {
            position: absolute; inset: 0;
            background: #1e293b;
            display: none; /* Toggled via JS */
            flex-direction: column;
            align-items: center; justify-content: center;
            z-index: 20; 
        }
        
        .avatar-circle {
            width: 50px; height: 50px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 20px; font-weight: bold; color: white;
            box-shadow: 0 0 15px rgba(0,0,0,0.3);
            margin-bottom: 8px;
            text-shadow: 0 1px 3px rgba(0,0,0,0.5);
        }
        
        @media (min-width: 768px) {
            .avatar-circle { width: 80px; height: 80px; font-size: 32px; }
        }

        /* NAME TAG */
        .name-tag {
            position: absolute; bottom: 6px; left: 6px;
            background: rgba(0,0,0,0.7); padding: 4px 8px;
            border-radius: 6px; font-size: 11px; font-weight: 600;
            backdrop-filter: blur(4px); border: 1px solid rgba(255,255,255,0.15);
            color: white; z-index: 30;
            display: flex; align-items: center; gap: 6px;
            max-width: 90%;
        }
        .mic-off-icon { color: #ef4444; display: none; font-size: 10px; }

        /* CONTROLS */
        .control-bar {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 8px;
            padding: 10px 16px;
            background: rgba(15, 23, 42, 0.95);
            border: 1px solid rgba(255,255,255,0.15);
            backdrop-filter: blur(16px);
            border-radius: 100px;
            z-index: 60;
            box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.6);
        }
        
        .btn-control {
            width: 44px; height: 44px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 16px; color: white;
            background: rgba(255,255,255,0.1);
            transition: all 0.2s;
        }
        .btn-control:active { transform: scale(0.9); }
        .btn-red { background: #ef4444 !important; }
        .btn-white { background: #fff !important; color: #000 !important; }

        /* TOAST */
        #toast-container { 
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%); 
            z-index: 70; width: 90%; max-width: 350px;
            display: flex; flex-direction: column; gap: 8px; pointer-events: none;
        }
        .toast { 
            background: rgba(30, 41, 59, 0.95); color: white; 
            padding: 10px 16px; border-radius: 10px; 
            font-size: 13px; font-weight: 500;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            text-align: center; animation: fadeDown 0.3s;
        }
        @keyframes fadeDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-900">

    <!-- ================= 1. LANDING SCREEN ================= -->
    <div id="screen-home" class="fixed inset-0 z-50 flex flex-col items-center justify-center p-6 bg-slate-900 text-center">
        <div class="w-20 h-20 bg-blue-600 rounded-3xl flex items-center justify-center mb-6 shadow-2xl shadow-blue-600/20">
            <i class="fa-solid fa-video text-4xl text-white"></i>
        </div>
        <h1 class="text-3xl font-bold text-white mb-2">Team Sync</h1>
        <p class="text-slate-400 mb-8">Secure Mesh Video Calls</p>

        <div id="action-buttons" class="w-full max-w-xs space-y-4">
            <button onclick="createMeeting()" class="w-full py-4 bg-blue-600 hover:bg-blue-500 text-white rounded-2xl font-bold text-lg shadow-lg transition-all">
                Create Room
            </button>
            
            <div class="relative">
                <input id="manual-room" type="text" placeholder="Enter Room Code" class="w-full bg-slate-800 border border-slate-700 text-center text-white uppercase font-bold py-4 rounded-2xl outline-none focus:border-blue-500 transition-all">
                <button onclick="joinManual()" class="absolute right-2 top-2 bottom-2 bg-slate-700 hover:bg-green-600 text-white px-4 rounded-xl transition-colors"><i class="fa-solid fa-arrow-right"></i></button>
            </div>
        </div>

        <div id="loading-msg" class="hidden mt-8 flex items-center gap-3 text-blue-400 font-semibold">
            <i class="fa-solid fa-circle-notch fa-spin"></i> Connecting...
        </div>

        <div id="view-invited" class="hidden w-full max-w-xs bg-slate-800/50 p-6 rounded-3xl border border-slate-700 backdrop-blur mt-4">
            <p class="text-slate-400 text-xs uppercase font-bold mb-1">Joining Room</p>
            <p id="invite-code" class="text-2xl font-mono font-bold text-white mb-4">---</p>
            <button onclick="joinInvited()" class="w-full py-3 bg-green-600 hover:bg-green-500 text-white rounded-xl font-bold shadow-lg">Join Now</button>
        </div>
    </div>

    <!-- ================= 2. MEETING ROOM ================= -->
    <div id="screen-meeting" class="hidden fixed inset-0 z-0 bg-slate-950">
        <!-- Top Bar -->
        <div class="absolute top-0 left-0 right-0 p-3 flex justify-center z-40 pointer-events-none">
            <div class="pointer-events-auto bg-slate-900/90 backdrop-blur px-4 py-2 rounded-full border border-white/10 flex items-center gap-3 shadow-lg cursor-pointer hover:bg-slate-800 transition-colors" onclick="copyLink()">
                <span id="room-display" class="font-mono font-bold text-white text-sm tracking-wider">---</span>
                <i class="fa-regular fa-copy text-slate-400 text-xs"></i>
            </div>
        </div>

        <div id="toast-container"></div>
        <div id="video-grid"></div>

        <div class="control-bar">
            <button onclick="toggleAudio()" id="btn-mic" class="btn-control"><i class="fa-solid fa-microphone"></i></button>
            <button onclick="toggleVideo()" id="btn-vid" class="btn-control"><i class="fa-solid fa-video"></i></button>
            <button onclick="switchCamera()" class="btn-control"><i class="fa-solid fa-camera-rotate"></i></button>
            <button onclick="shareLink()" class="btn-control"><i class="fa-solid fa-share-nodes"></i></button>
            <button onclick="leaveMeeting()" class="btn-control btn-red"><i class="fa-solid fa-phone-slash"></i></button>
        </div>
    </div>

    <script>
        // --- CONFIG ---
        const peerConfig = { debug: 1 };
        let peer = null;
        let myId = null;
        let myStream = null;
        let roomId = null;
        let isHost = false;
        let myName = generateRandomName();
        let currentCam = 'user';
        let videoEnabled = true;
        let audioEnabled = true;
        
        // Peers Store: { id: { conn, call, name } }
        const peers = {}; 

        window.onload = () => {
            const urlParams = new URLSearchParams(window.location.search);
            const r = urlParams.get('room');
            if (r) {
                roomId = r;
                document.getElementById('action-buttons').classList.add('hidden');
                document.getElementById('view-invited').classList.remove('hidden');
                document.getElementById('invite-code').innerText = roomId;
            }
        };

        // --- ACTIONS ---
        async function createMeeting() {
            isHost = true; roomId = generateRoomId();
            await startSession();
        }
        async function joinInvited() { await startSession(); }
        async function joinManual() {
            const val = document.getElementById('manual-room').value.trim().toUpperCase();
            if(!val) return showToast("Enter Code");
            roomId = val; await startSession();
        }

        async function startSession() {
            document.getElementById('loading-msg').classList.remove('hidden');
            document.getElementById('action-buttons').classList.add('hidden');
            document.getElementById('view-invited').classList.add('hidden');
            
            // 1. Init Peer
            await initPeer(isHost ? roomId : generateRoomId());
            
            // 2. Get Media
            await enterRoomUI();
            
            // 3. Connect if Guest
            if (!isHost) connectToHost(roomId);
            showToast(isHost ? "Room Created" : "Joined Room");
        }

        // --- PEER LOGIC ---
        function initPeer(id) {
            return new Promise(resolve => {
                peer = new Peer(id, peerConfig);
                peer.on('open', id => { myId = id; resolve(); });
                
                // Handle incoming calls
                peer.on('call', call => {
                    call.answer(myStream); 
                    handleCall(call);
                });
                
                // Handle incoming data
                peer.on('connection', conn => handleData(conn));
                
                peer.on('error', e => {
                    if(e.type === 'unavailable-id') alert("Room taken.");
                    location.reload();
                });
            });
        }

        function connectToHost(hostId) {
            const conn = peer.connect(hostId);
            conn.on('open', () => sendHandshake(conn));
            handleData(conn);
        }

        function handleData(conn) {
            conn.on('open', () => {
                if(!peers[conn.peer]) peers[conn.peer] = {};
                peers[conn.peer].conn = conn;
            });

            conn.on('data', data => {
                // Handshake: Receive Name/Status
                if (data.type === 'handshake') {
                    if(!peers[data.from]) peers[data.from] = {};
                    peers[data.from].name = data.name;
                    
                    if(!document.getElementById(`video-${data.from}`)) showToast(`${data.name} joined`);

                    // Apply status immediately
                    setTimeout(() => {
                        updateVideoStatus(data.from, data.videoEnabled);
                        updateAudioStatus(data.from, data.audioEnabled);
                    }, 500);

                    // Host Logic: Send peer list
                    if(isHost && !data.isReply) {
                        const list = Object.keys(peers).filter(p => p !== data.from);
                        list.push(myId);
                        conn.send({ type: 'peer-list', list: list });
                    }
                }
                
                // Peer List: Guest calls everyone
                if (data.type === 'peer-list') {
                    data.list.forEach(pid => { 
                        if(pid !== myId) connectToPeer(pid); 
                    });
                }

                // Status Updates
                if (data.type === 'video-status') updateVideoStatus(data.from, data.enabled);
                if (data.type === 'audio-status') updateAudioStatus(data.from, data.enabled);
            });
            
            conn.on('close', () => handleDisconnect(conn.peer));
        }

        function connectToPeer(pid) {
            // CRITICAL FIX: Don't skip if we have data but no call
            // We check if we already have a CALL
            if(peers[pid]?.call) return;

            // 1. Initiate Video Call
            const call = peer.call(pid, myStream);
            handleCall(call);
            
            // 2. Initiate Data (if not exists)
            if(!peers[pid]?.conn) {
                const conn = peer.connect(pid);
                conn.on('open', () => sendHandshake(conn));
                handleData(conn);
            } else {
                // If data exists, just send handshake again to ensure sync
                sendHandshake(peers[pid].conn);
            }
        }

        function sendHandshake(conn, isReply = false) {
            conn.send({ 
                type: 'handshake', from: myId, name: myName, 
                videoEnabled: videoEnabled, audioEnabled: audioEnabled, isReply: isReply 
            });
        }

        function handleCall(call) {
            if(!peers[call.peer]) peers[call.peer] = {};
            peers[call.peer].call = call;

            call.on('stream', stream => {
                // Wait slightly to ensure name data arrived via DataConnection
                setTimeout(() => {
                    addVideoToGrid(stream, call.peer, peers[call.peer]?.name || "User");
                }, 200);
            });
            call.on('close', () => handleDisconnect(call.peer));
            call.on('error', () => handleDisconnect(call.peer));
        }

        function handleDisconnect(id) {
            if(document.getElementById(`video-${id}`)) {
                showToast(`${peers[id]?.name || 'User'} left`);
                document.getElementById(`video-${id}`).remove();
            }
            delete peers[id];
        }

        // --- VIDEO & UI ---
        async function enterRoomUI() {
            try {
                myStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' }, audio: true });
            } catch(e) {
                myStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            }

            document.getElementById('screen-home').classList.add('hidden');
            document.getElementById('screen-meeting').classList.remove('hidden');
            document.getElementById('room-display').innerText = roomId;

            addVideoToGrid(myStream, 'me', myName + " (You)", true);
        }

        function addVideoToGrid(stream, id, name, isLocal = false) {
            // Prevent duplicates
            if(document.getElementById(`video-${id}`)) return;

            const color = getColor(id);
            const grid = document.getElementById('video-grid');
            
            const card = document.createElement('div');
            card.className = 'video-card';
            card.id = `video-${id}`;
            card.style.borderColor = color;
            card.onclick = () => {
                if(card.classList.contains('pinned')) card.classList.remove('pinned');
                else {
                    document.querySelectorAll('.video-card.pinned').forEach(c => c.classList.remove('pinned'));
                    card.classList.add('pinned');
                }
            };

            const vid = document.createElement('video');
            vid.srcObject = stream;
            vid.autoplay = true;
            vid.playsInline = true;
            if(isLocal) { vid.muted = true; vid.style.transform = "scaleX(-1)"; }

            // Avatar Overlay
            const avatar = document.createElement('div');
            avatar.className = 'avatar-overlay';
            avatar.innerHTML = `
                <div class="avatar-circle" style="background:${color}">${name.charAt(0).toUpperCase()}</div>
                <div class="text-slate-300 font-bold">${name}</div>
            `;

            // Name Tag
            const tag = document.createElement('div');
            tag.className = 'name-tag';
            tag.innerHTML = `<span>${name}</span><i class="fa-solid fa-microphone-slash mic-off-icon"></i>`;

            card.appendChild(vid);
            card.appendChild(avatar);
            card.appendChild(tag);
            grid.appendChild(card);
        }

        // --- UPDATES ---
        function updateVideoStatus(id, enabled) {
            const card = document.getElementById(`video-${id}`);
            if(!card) return;
            const vid = card.querySelector('video');
            const av = card.querySelector('.avatar-overlay');
            if(enabled) { vid.style.opacity = 1; av.style.display = 'none'; }
            else { vid.style.opacity = 0; av.style.display = 'flex'; }
        }

        function updateAudioStatus(id, enabled) {
            const card = document.getElementById(`video-${id}`);
            if(!card) return;
            const icon = card.querySelector('.mic-off-icon');
            icon.style.display = enabled ? 'none' : 'block';
        }

        // --- CONTROLS ---
        function toggleAudio() {
            audioEnabled = !audioEnabled;
            myStream.getAudioTracks()[0].enabled = audioEnabled;
            document.getElementById('btn-mic').classList.toggle('btn-white', !audioEnabled);
            broadcast({ type: 'audio-status', enabled: audioEnabled });
        }

        function toggleVideo() {
            videoEnabled = !videoEnabled;
            myStream.getVideoTracks()[0].enabled = videoEnabled;
            document.getElementById('btn-vid').classList.toggle('btn-white', !videoEnabled);
            updateVideoStatus('me', videoEnabled);
            broadcast({ type: 'video-status', enabled: videoEnabled });
        }

        async function switchCamera() {
            currentCam = currentCam === 'user' ? 'environment' : 'user';
            myStream.getVideoTracks().forEach(t => t.stop());
            const newStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: currentCam }, audio: true });
            const newTrack = newStream.getVideoTracks()[0];
            
            Object.values(peers).forEach(p => {
                const sender = p.call?.peerConnection?.getSenders().find(s => s.track.kind === 'video');
                if(sender) sender.replaceTrack(newTrack);
            });
            
            const myVid = document.querySelector('#video-me video');
            myVid.srcObject = newStream;
            myVid.style.transform = currentCam === 'user' ? "scaleX(-1)" : "none";
            myStream = newStream;
            newTrack.enabled = videoEnabled; 
        }

        function broadcast(msg) {
            msg.from = myId;
            Object.values(peers).forEach(p => { if(p.conn && p.conn.open) p.conn.send(msg); });
        }

        function leaveMeeting() {
            if(peer) peer.destroy();
            location.href = window.location.pathname;
        }

        function copyLink() {
            navigator.clipboard.writeText(`${window.location.origin}${window.location.pathname}?room=${roomId}`);
            showToast("Link Copied");
        }
        
        function shareLink() {
            const url = `${window.location.origin}${window.location.pathname}?room=${roomId}`;
            if(navigator.share) navigator.share({title:'Join Call', url: url}); else copyLink();
        }

        // --- UTILS ---
        function generateRoomId() { return Math.random().toString(36).substring(2, 7).toUpperCase(); }
        function generateRandomName() {
            const a = ["Neon", "Fast", "Sky", "Blue", "Red", "Pro", "Dark"];
            const b = ["Fox", "Bear", "Owl", "Cat", "Dog", "Lion", "Wolf"];
            return a[Math.floor(Math.random()*a.length)] + " " + b[Math.floor(Math.random()*b.length)];
        }
        function getColor(id) {
            let h = 0; for(let i=0;i<id.length;i++) h = id.charCodeAt(i) + ((h<<5)-h);
            return `hsl(${Math.abs(h)%360}, 80%, 60%)`;
        }
        function showToast(msg) {
            const d = document.createElement('div'); d.className='toast'; d.innerText=msg;
            document.getElementById('toast-container').appendChild(d);
            setTimeout(()=>d.remove(), 3000);
        }
    </script>
</body>
</html>
