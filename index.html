<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ScreenMirror Pro + Remote Zoom</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: sans-serif; }
        .glass { background: rgba(30, 41, 59, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); }
        .anim-pulse-slow { animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
        
        /* Slider Styling */
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%; 
            background: #3b82f6; margin-top: -8px; box-shadow: 0 0 10px rgba(59,130,246,0.8); cursor: pointer;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; background: rgba(255,255,255,0.3); border-radius: 2px;
        }
        
        /* Sender Local Preview (Small) */
        #local-container { 
            position: fixed; bottom: 20px; right: 20px; 
            z-index: 50; display: none; 
            flex-direction: column; align-items: center;
        }
        #local-video-preview {
            width: 100px; height: 140px; object-fit: cover; 
            border-radius: 12px; border: 2px solid rgba(255,255,255,0.3);
            background: #000;
        }

        /* Receiver Remote Controls */
        #remote-controls {
            position: absolute; bottom: 80px; left: 50%; transform: translateX(-50%);
            width: 80%; max-width: 400px;
            background: rgba(0,0,0,0.6); padding: 15px 25px; border-radius: 50px;
            display: none; /* Hidden until caps received */
            backdrop-filter: blur(5px); border: 1px solid rgba(255,255,255,0.1);
            z-index: 30;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4 bg-gradient-to-br from-slate-900 to-slate-800">

    <!-- HEADER -->
    <div class="absolute top-6 left-0 right-0 text-center opacity-50">
        <h1 class="text-xl font-bold tracking-wider"><i class="fa-solid fa-tower-broadcast mr-2"></i>SCREEN MIRROR</h1>
    </div>

    <!-- 1. HOME SCREEN (Select Mode) -->
    <div id="menu-panel" class="glass p-8 rounded-2xl shadow-2xl max-w-md w-full text-center transition-all duration-500">
        <h2 class="text-2xl font-bold mb-2 text-white">Select Device Role</h2>
        <p class="text-slate-400 mb-8 text-sm">Mirror your phone screen to this device</p>

        <div class="grid grid-cols-1 gap-4">
            <button onclick="initReceiver()" class="group relative p-6 rounded-xl bg-blue-600 hover:bg-blue-500 transition-all text-white shadow-lg hover:shadow-blue-500/25">
                <div class="flex items-center justify-center gap-4">
                    <i class="fa-solid fa-desktop text-3xl"></i>
                    <div class="text-left">
                        <div class="font-bold text-lg">Receive Screen</div>
                        <div class="text-blue-200 text-xs">Use this on PC, Laptop, or TV</div>
                    </div>
                </div>
            </button>
            <button onclick="showManualConnect()" class="p-4 rounded-xl bg-slate-700 hover:bg-slate-600 transition-all text-slate-300 border border-slate-600">
                <i class="fa-solid fa-mobile-screen mr-2"></i> I want to share this screen
            </button>
        </div>
    </div>

    <!-- 2. RECEIVER UI (PC) -->
    <div id="receiver-panel" class="hidden w-full max-w-6xl flex flex-col items-center">
        <!-- WAITING STATE -->
        <div id="receiver-waiting" class="glass p-10 rounded-3xl text-center max-w-lg w-full shadow-2xl border-2 border-blue-500/30 relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-blue-500 via-purple-500 to-blue-500 anim-pulse-slow"></div>
            <h3 class="text-2xl font-bold text-white mb-2">Scan to Connect</h3>
            <p class="text-slate-400 mb-6">Open your phone's camera and scan this code</p>
            <div class="bg-white p-4 rounded-xl inline-block shadow-inner mb-6">
                <div id="qrcode"></div>
            </div>
            <div class="text-xs text-slate-500 font-mono bg-slate-900/50 p-2 rounded">
                ID: <span id="display-id" class="text-blue-400 font-bold text-lg select-all">Generating...</span>
            </div>
            <div class="mt-6 flex items-center justify-center gap-2 text-xs text-slate-500">
                <div class="w-2 h-2 bg-green-500 rounded-full animate-ping"></div> Waiting for connection...
            </div>
            <button onclick="location.reload()" class="mt-8 text-slate-500 hover:text-white text-sm underline">Cancel</button>
        </div>

        <!-- CONNECTED STATE -->
        <div id="video-container" class="hidden w-full flex flex-col items-center relative">
            <div class="w-full bg-black rounded-xl shadow-2xl overflow-hidden border border-slate-700 relative aspect-video max-h-[85vh] group">
                <video id="remote-video" autoplay playsinline muted controls class="w-full h-full object-contain"></video>
                
                <!-- REMOTE ZOOM CONTROLS (On PC) -->
                <div id="remote-controls" class="flex items-center gap-4 transition-opacity duration-300 opacity-0 group-hover:opacity-100">
                    <span class="text-xs font-bold text-blue-300 uppercase tracking-wider">Zoom</span>
                    <i class="fa-solid fa-image text-slate-400 text-xs"></i>
                    <input type="range" id="pc-zoom-slider" min="1" max="10" step="0.1" value="1" oninput="sendZoomCommand(this.value)">
                    <i class="fa-solid fa-images text-slate-400 text-lg"></i>
                    <span id="pc-zoom-value" class="text-xs font-mono text-white w-8">1.0x</span>
                </div>

                <div id="video-status" class="absolute inset-0 flex items-center justify-center bg-black/80 z-10 hidden">
                     <p class="text-white"><i class="fa-solid fa-spinner fa-spin mr-2"></i> Loading Stream...</p>
                </div>
                <div id="video-overlay" class="absolute bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-black/80 to-transparent opacity-0 group-hover:opacity-100 transition-opacity flex justify-between items-center z-20 pointer-events-none">
                    <span class="text-white font-mono text-sm"><i class="fa-solid fa-circle text-red-500 text-[10px] mr-2 animate-pulse"></i>LIVE</span>
                    <button onclick="toggleFullScreen()" class="text-white hover:text-blue-400 pointer-events-auto"><i class="fa-solid fa-expand"></i> Fullscreen</button>
                </div>
            </div>
            <button onclick="location.reload()" class="mt-4 px-6 py-2 bg-slate-800 hover:bg-red-500/20 text-slate-300 hover:text-red-400 rounded-full transition-colors border border-slate-700">
                <i class="fa-solid fa-power-off mr-2"></i> Stop Mirroring
            </button>
        </div>
    </div>

    <!-- 3. SENDER UI (Phone) -->
    <div id="sender-panel" class="hidden glass p-8 rounded-2xl shadow-2xl max-w-sm w-full text-center">
        <div class="w-16 h-16 bg-blue-600 rounded-full flex items-center justify-center mx-auto mb-6 shadow-lg shadow-blue-500/50">
            <i class="fa-solid fa-tower-broadcast text-2xl text-white"></i>
        </div>
        <h2 class="text-2xl font-bold text-white mb-2">Ready to Mirror</h2>
        <p class="text-slate-400 mb-8 text-sm">Cast your screen to the connected device.</p>
        <div id="connection-status" class="hidden mb-4 text-yellow-400 text-sm animate-pulse">Connecting...</div>

        <button id="start-share-btn" onclick="startSharing('screen')" class="w-full py-4 bg-green-600 hover:bg-green-500 text-white font-bold rounded-xl shadow-lg hover:shadow-green-500/30 transition-all transform hover:-translate-y-1 mb-3">
            <i class="fa-solid fa-mobile-screen mr-2"></i> Share Screen
        </button>
        <button id="start-cam-btn" onclick="startSharing('camera')" class="w-full py-3 bg-slate-700 hover:bg-slate-600 text-white font-semibold rounded-xl shadow border border-slate-600 transition-all mb-3">
            <i class="fa-solid fa-camera mr-2"></i> Share Camera
        </button>
        <button onclick="location.href=window.location.pathname" class="text-slate-500 text-sm mt-4">Cancel</button>
    </div>

    <!-- 4. MANUAL CONNECT -->
    <div id="manual-panel" class="hidden glass p-8 rounded-2xl max-w-sm w-full text-center">
        <h3 class="text-lg font-bold mb-4">Enter ID from PC</h3>
        <input type="text" id="manual-id-input" placeholder="e.g. AB123" class="w-full bg-slate-900 border border-slate-700 p-3 rounded-lg text-center text-white text-lg font-mono uppercase mb-4 focus:border-blue-500 outline-none">
        <button onclick="connectToId(document.getElementById('manual-id-input').value)" class="w-full py-3 bg-blue-600 rounded-lg text-white font-bold">Connect</button>
        <button onclick="location.reload()" class="mt-4 text-slate-500 text-sm">Back</button>
    </div>

    <!-- 5. SENDER LOCAL PREVIEW (Hidden controls, just video) -->
    <div id="local-container">
        <video id="local-video-preview" autoplay playsinline muted></video>
        <div id="wakelock-status" class="mt-1 text-[10px] text-green-400 hidden bg-black/50 px-2 rounded">
            <i class="fa-solid fa-bolt"></i> Active
        </div>
    </div>

    <script>
        // --- CONFIG ---
        const peerConfig = { debug: 1 }; 
        let peer = null;
        let targetPeerId = null;
        let wakeLock = null;
        
        // Data Connections
        let senderDataConn = null; // Phone -> PC
        let receiverDataConn = null; // PC -> Phone

        // --- INIT ---
        window.onload = () => {
            const urlParams = new URLSearchParams(window.location.search);
            const refId = urlParams.get('ref');
            if (refId) {
                showPanel('sender-panel');
                targetPeerId = refId;
            } else {
                showPanel('menu-panel');
            }
        };

        // --- RECEIVER (PC) LOGIC ---
        function initReceiver() {
            showPanel('receiver-panel');
            const myId = generateId();
            document.getElementById('display-id').innerText = myId;

            const fullUrl = `${window.location.origin}${window.location.pathname}?ref=${myId}`;
            new QRCode(document.getElementById("qrcode"), {
                text: fullUrl, width: 180, height: 180,
                colorDark : "#000000", colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });

            peer = new Peer(myId, peerConfig);
            
            // 1. Listen for Media Call
            peer.on('call', (call) => {
                document.getElementById('receiver-waiting').classList.add('hidden');
                document.getElementById('video-container').classList.remove('hidden');
                document.getElementById('video-status').classList.remove('hidden');
                
                call.answer();
                call.on('stream', (remoteStream) => {
                    document.getElementById('video-status').classList.add('hidden');
                    const video = document.getElementById('remote-video');
                    video.srcObject = remoteStream;
                    video.play().catch(e => console.log(e));
                });
                call.on('close', () => location.reload());
            });

            // 2. Listen for Data Connection (For Zoom Controls)
            peer.on('connection', (conn) => {
                receiverDataConn = conn;
                
                conn.on('data', (data) => {
                    if (data.type === 'init-zoom') {
                        // Phone sent its capabilities
                        const slider = document.getElementById('pc-zoom-slider');
                        const container = document.getElementById('remote-controls');
                        
                        slider.min = data.min;
                        slider.max = data.max;
                        slider.step = data.step || 0.1;
                        slider.value = data.current;
                        
                        document.getElementById('pc-zoom-value').innerText = data.current + "x";
                        
                        // Show controls on PC
                        container.style.display = 'flex';
                        setTimeout(() => container.classList.remove('opacity-0'), 100);
                    }
                });
            });
        }

        // Called by PC Slider
        function sendZoomCommand(val) {
            document.getElementById('pc-zoom-value').innerText = val + "x";
            if (receiverDataConn && receiverDataConn.open) {
                receiverDataConn.send({ type: 'zoom', value: val });
            }
        }

        // --- SENDER (PHONE) LOGIC ---
        function showManualConnect() { showPanel('manual-panel'); }
        function connectToId(id) {
            if(!id) return alert("Enter ID");
            targetPeerId = id.trim();
            showPanel('sender-panel');
        }

        async function startSharing(mode) {
            const btn = document.getElementById(mode === 'screen' ? 'start-share-btn' : 'start-cam-btn');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Starting...';

            try {
                if(!peer) {
                     peer = new Peer(generateId(), peerConfig);
                     await new Promise(resolve => peer.on('open', resolve));
                }

                let stream = null;

                if (mode === 'screen') {
                    stream = await navigator.mediaDevices.getDisplayMedia({
                        video: { cursor: "always" }, audio: false 
                    });
                } else {
                    // CAMERA MODE
                    const constraints = { 
                        video: { 
                            facingMode: 'environment', width: { ideal: 1920 }, height: { ideal: 1080 },
                            focusMode: 'continuous'
                        },
                        audio: true 
                    };
                    try { stream = await navigator.mediaDevices.getUserMedia(constraints); } 
                    catch(e) { stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true }); }

                    // Show Local Preview
                    document.getElementById('local-video-preview').srcObject = stream;
                    document.getElementById('local-container').style.display = 'flex';
                    
                    // --- SETUP REMOTE CONTROL ---
                    // 1. Connect to PC for data
                    senderDataConn = peer.connect(targetPeerId);
                    senderDataConn.on('open', () => {
                         // 2. Read Capabilities & Send to PC
                         const track = stream.getVideoTracks()[0];
                         const caps = track.getCapabilities ? track.getCapabilities() : {};
                         const settings = track.getSettings ? track.getSettings() : {};
                         
                         if ('zoom' in caps) {
                             senderDataConn.send({
                                 type: 'init-zoom',
                                 min: caps.zoom.min,
                                 max: caps.zoom.max,
                                 step: caps.zoom.step,
                                 current: settings.zoom || 1
                             });
                         }
                    });

                    // 3. Listen for Commands from PC
                    senderDataConn.on('data', async (data) => {
                        if(data.type === 'zoom') {
                            const track = stream.getVideoTracks()[0];
                            try { await track.applyConstraints({ advanced: [{ zoom: data.value }] }); } 
                            catch (e) { console.log("Zoom Error", e); }
                        }
                    });
                }

                requestWakeLock();
                const call = peer.call(targetPeerId, stream);

                // UI
                btn.classList.replace('bg-green-600', 'bg-red-600');
                btn.classList.replace('bg-slate-700', 'bg-red-600');
                btn.innerHTML = '<i class="fa-solid fa-stop"></i> Stop Sharing';
                
                const stopSharing = () => {
                    stream.getTracks().forEach(track => track.stop());
                    document.getElementById('local-container').style.display = 'none';
                    if(senderDataConn) senderDataConn.close();
                    if(wakeLock) wakeLock.release();
                    location.href = window.location.pathname;
                };

                btn.onclick = stopSharing;
                stream.getVideoTracks()[0].onended = stopSharing;

            } catch (err) {
                console.error(err);
                alert("Error: " + err.message);
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        async function requestWakeLock() {
            try {
                if ('wakeLock' in navigator) {
                    wakeLock = await navigator.wakeLock.request('screen');
                    document.getElementById('wakelock-status').classList.remove('hidden');
                }
            } catch (err) { console.log(err); }
        }

        function showPanel(id) {
            ['menu-panel', 'receiver-panel', 'sender-panel', 'manual-panel'].forEach(p => {
                document.getElementById(p).classList.add('hidden');
            });
            document.getElementById(id).classList.remove('hidden');
        }
        function generateId() { return Math.floor(Math.random()*16777215).toString(16).slice(0,4).toUpperCase(); }
        function toggleFullScreen() {
            if (!document.fullscreenElement) document.documentElement.requestFullscreen();
            else if (document.exitFullscreen) document.exitFullscreen();
        }
    </script>
</body>
</html>
