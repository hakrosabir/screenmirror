<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Simple Video Call</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PeerJS -->
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { background-color: #000; color: #fff; font-family: system-ui, -apple-system, sans-serif; overflow: hidden; }
        
        /* Glassmorphism utilities */
        .glass { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        .btn-glass { background: rgba(255, 255, 255, 0.2); backdrop-filter: blur(4px); border: 1px solid rgba(255,255,255,0.1); }
        
        /* Video Layout */
        #remote-video { object-fit: cover; width: 100%; height: 100%; }
        
        /* Local PIP */
        #local-video-container {
            position: absolute; bottom: 100px; right: 20px;
            width: 100px; height: 150px;
            background: #1e293b; border-radius: 12px;
            overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            border: 2px solid rgba(255,255,255,0.2);
            transition: all 0.3s ease;
            z-index: 20;
        }
        #local-video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); } /* Mirror local */
        
        /* Controls */
        .control-bar {
            position: absolute; bottom: 0; left: 0; right: 0;
            padding: 20px; padding-bottom: 30px;
            display: flex; justify-content: space-evenly; align-items: center;
            background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
            z-index: 30;
        }
        
        .btn-control {
            width: 50px; height: 50px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 20px; color: white; transition: transform 0.1s;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        .btn-control:active { transform: scale(0.95); }
        
        /* Animations */
        .pulse-ring { animation: ring 2s infinite; }
        @keyframes ring { 0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(59, 130, 246, 0); } 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); } }
    </style>
</head>
<body class="h-screen w-screen flex flex-col">

    <!-- ================= SCREEN 1: HOME / LANDING ================= -->
    <div id="screen-home" class="fixed inset-0 z-50 flex flex-col items-center justify-center p-6 bg-slate-900">
        <div class="w-full max-w-sm text-center space-y-8">
            
            <div class="mb-8">
                <div class="w-24 h-24 bg-blue-600 rounded-full flex items-center justify-center mx-auto mb-4 shadow-2xl shadow-blue-600/40">
                    <i class="fa-solid fa-video text-4xl"></i>
                </div>
                <h1 class="text-3xl font-bold text-white">Video Call</h1>
                <p class="text-slate-400 text-sm mt-2">Secure P2P Connection</p>
            </div>

            <!-- Default View: "Start Call" or "Enter Code" -->
            <div id="view-default" class="space-y-4 w-full">
                <button onclick="startAsHost()" class="w-full py-4 bg-blue-600 hover:bg-blue-500 rounded-2xl font-bold text-lg shadow-lg shadow-blue-900/20 transition-all active:scale-95">
                    Start New Call
                </button>
                
                <button onclick="toggleManualInput()" class="w-full py-4 bg-slate-800 hover:bg-slate-700 rounded-2xl font-semibold text-slate-300 border border-slate-700 transition-all active:scale-95">
                    Receive Call (Enter Code)
                </button>
            </div>

            <!-- Link View: Seen when opening a link -->
            <div id="view-join" class="space-y-4 w-full hidden">
                <p class="text-slate-300 mb-4">You have been invited to a call.</p>
                <button onclick="joinCall()" class="w-full py-4 bg-green-600 hover:bg-green-500 pulse-ring rounded-2xl font-bold text-lg shadow-lg shadow-green-900/20 transition-all active:scale-95">
                    Join Call
                </button>
            </div>

            <!-- Waiting View: Host waiting for guest -->
            <div id="view-waiting" class="space-y-6 w-full hidden">
                <div class="glass p-6 rounded-2xl border border-blue-500/30">
                    <p class="text-sm text-slate-400 mb-2">Share this link to connect:</p>
                    
                    <div class="flex gap-2 mb-4">
                        <input id="share-link" readonly class="w-full bg-slate-950 border border-slate-700 rounded-lg px-3 py-2 text-xs text-slate-300 font-mono focus:outline-none">
                        <button onclick="copyLink()" class="bg-blue-600 px-4 rounded-lg text-white hover:bg-blue-500"><i class="fa-regular fa-copy"></i></button>
                    </div>

                    <div class="flex items-center justify-center gap-3 text-blue-400 text-sm animate-pulse">
                        <i class="fa-solid fa-spinner fa-spin"></i> Waiting for answer...
                    </div>
                </div>
                <button onclick="location.reload()" class="text-slate-500 text-sm underline">Cancel</button>
            </div>

            <!-- Manual Input View -->
            <div id="view-manual" class="space-y-4 w-full hidden">
                <input id="manual-id" type="text" placeholder="Enter Call ID" class="w-full py-4 px-6 bg-slate-800 rounded-2xl text-center text-white font-bold text-xl uppercase tracking-widest border border-slate-700 focus:border-blue-500 outline-none">
                <button onclick="manualJoin()" class="w-full py-4 bg-green-600 hover:bg-green-500 rounded-2xl font-bold shadow-lg">Connect</button>
                <button onclick="toggleManualInput()" class="text-slate-500 text-sm">Back</button>
            </div>

        </div>
    </div>

    <!-- ================= SCREEN 2: ACTIVE CALL ================= -->
    <div id="screen-call" class="fixed inset-0 z-0 hidden bg-black">
        <!-- Remote Stream (Full Screen) -->
        <video id="remote-video" autoplay playsinline></video>

        <!-- Local Stream (PIP) -->
        <div id="local-video-container">
            <video id="local-video" autoplay playsinline muted></video>
        </div>

        <!-- Controls -->
        <div class="control-bar">
            <!-- Switch Camera -->
            <button onclick="switchCamera()" class="btn-control btn-glass">
                <i class="fa-solid fa-camera-rotate"></i>
            </button>

            <!-- Hang Up -->
            <button onclick="endCall()" class="btn-control bg-red-600 hover:bg-red-500 shadow-red-600/40 transform scale-110">
                <i class="fa-solid fa-phone-slash"></i>
            </button>

            <!-- Mute/Unmute -->
            <button onclick="toggleMute()" id="btn-mute" class="btn-control btn-glass">
                <i class="fa-solid fa-microphone"></i>
            </button>
        </div>

        <!-- Status Toast -->
        <div id="status-toast" class="absolute top-10 left-1/2 transform -translate-x-1/2 bg-black/60 px-4 py-2 rounded-full text-xs font-medium backdrop-blur-md border border-white/10 hidden">
            Connecting...
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const peerConfig = { debug: 1 };
        let peer = null;
        let currentCall = null;
        let localStream = null;
        let currentCamera = 'user'; // 'user' or 'environment'
        let targetId = null;

        // --- INITIALIZATION ---
        window.onload = () => {
            const urlParams = new URLSearchParams(window.location.search);
            const callId = urlParams.get('call');
            
            if (callId) {
                // Opened via link -> Receiver Mode
                targetId = callId;
                showView('view-join');
            } else {
                // Opened normally -> Landing Mode
                showView('view-default');
            }
        };

        // --- HOST LOGIC (Caller) ---
        function startAsHost() {
            const myId = generateId();
            initializePeer(myId);
            
            // Update UI to Waiting Room
            const link = `${window.location.origin}${window.location.pathname}?call=${myId}`;
            document.getElementById('share-link').value = link;
            showView('view-waiting');

            // Listen for incoming connection
            peer.on('call', async (call) => {
                await setupLocalStream();
                call.answer(localStream); // Answer with our stream
                handleCall(call);
            });
        }

        function copyLink() {
            const copyText = document.getElementById("share-link");
            copyText.select();
            copyText.setSelectionRange(0, 99999); 
            navigator.clipboard.writeText(copyText.value).then(() => {
                const btn = document.querySelector('button[onclick="copyLink()"]');
                btn.innerHTML = '<i class="fa-solid fa-check"></i>';
                setTimeout(() => btn.innerHTML = '<i class="fa-regular fa-copy"></i>', 2000);
            });
        }

        // --- GUEST LOGIC (Receiver) ---
        async function joinCall() {
            // We don't need a specific ID, just a random one to connect
            const myId = generateId();
            initializePeer(myId);

            // Peer must be ready before calling
            peer.on('open', async () => {
                await setupLocalStream();
                const call = peer.call(targetId, localStream);
                handleCall(call);
            });
        }

        function manualJoin() {
            const inputId = document.getElementById('manual-id').value.trim();
            if (!inputId) return alert("Please enter a valid ID");
            targetId = inputId;
            joinCall();
        }

        // --- CORE CALL HANDLING ---
        function initializePeer(id) {
            peer = new Peer(id, peerConfig);
            peer.on('error', err => alert("Connection Error: " + err.type));
        }

        async function setupLocalStream() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: currentCamera },
                    audio: true
                });
                
                // Show local preview
                document.getElementById('screen-home').classList.add('hidden');
                document.getElementById('screen-call').classList.remove('hidden');
                document.getElementById('local-video').srcObject = localStream;
                
                showToast("Connecting...");
            } catch (err) {
                console.error(err);
                alert("Camera access denied. Please allow permissions.");
                location.href = window.location.pathname;
            }
        }

        function handleCall(call) {
            currentCall = call;

            // Receive Remote Stream
            call.on('stream', (remoteStream) => {
                showToast("Connected");
                const video = document.getElementById('remote-video');
                video.srcObject = remoteStream;
            });

            call.on('close', () => endCall());
            call.on('error', () => endCall());
        }

        // --- IN-CALL FEATURES ---
        
        async function switchCamera() {
            if (!localStream) return;
            
            // Toggle mode
            currentCamera = currentCamera === 'user' ? 'environment' : 'user';
            const videoTrack = localStream.getVideoTracks()[0];

            try {
                // 1. Get new stream
                const newStream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: currentCamera },
                    audio: true
                });
                
                const newVideoTrack = newStream.getVideoTracks()[0];

                // 2. Replace track in PeerConnection (Seamless switch)
                if (currentCall && currentCall.peerConnection) {
                    const sender = currentCall.peerConnection.getSenders().find(s => s.track.kind === 'video');
                    if (sender) {
                        sender.replaceTrack(newVideoTrack);
                    }
                }

                // 3. Update Local View
                localStream.removeTrack(videoTrack);
                localStream.addTrack(newVideoTrack);
                document.getElementById('local-video').srcObject = newStream;
                
                // Update reference
                localStream = newStream;

                // Stop old track to release hardware
                videoTrack.stop();

            } catch (err) {
                console.error("Switch Camera Failed", err);
                alert("Could not switch camera.");
                currentCamera = currentCamera === 'user' ? 'environment' : 'user'; // Revert
            }
        }

        function toggleMute() {
            const audioTrack = localStream.getAudioTracks()[0];
            const btn = document.getElementById('btn-mute');
            
            if (audioTrack.enabled) {
                audioTrack.enabled = false;
                btn.innerHTML = '<i class="fa-solid fa-microphone-slash"></i>';
                btn.classList.add('bg-red-500/50');
            } else {
                audioTrack.enabled = true;
                btn.innerHTML = '<i class="fa-solid fa-microphone"></i>';
                btn.classList.remove('bg-red-500/50');
            }
        }

        function endCall() {
            if (currentCall) currentCall.close();
            if (localStream) localStream.getTracks().forEach(t => t.stop());
            window.location.href = window.location.pathname; // Reload clean
        }

        // --- UI UTILS ---
        function showView(viewId) {
            // Hide all views in home screen
            ['view-default', 'view-join', 'view-waiting', 'view-manual'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            // Show requested view
            document.getElementById(viewId).classList.remove('hidden');
        }

        function toggleManualInput() {
            const def = document.getElementById('view-default');
            const man = document.getElementById('view-manual');
            if (def.classList.contains('hidden')) {
                def.classList.remove('hidden');
                man.classList.add('hidden');
            } else {
                def.classList.add('hidden');
                man.classList.remove('hidden');
            }
        }

        function showToast(msg) {
            const t = document.getElementById('status-toast');
            t.innerText = msg;
            t.classList.remove('hidden');
            setTimeout(() => t.classList.add('hidden'), 3000);
        }

        function generateId() {
            // Generate a short 4-char random ID
            return Math.floor(Math.random()*16777215).toString(16).slice(0,4).toUpperCase();
        }
    </script>
</body>
</html>
