<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ScreenMirror One-Link</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: sans-serif; overflow: hidden; touch-action: none; }
        .glass { background: rgba(30, 41, 59, 0.85); backdrop-filter: blur(16px); border: 1px solid rgba(255,255,255,0.1); }
        
        /* Custom Slider */
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; 
            background: #3b82f6; margin-top: -6px; cursor: pointer; transition: transform 0.1s;
        }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: #334155; border-radius: 2px; }
        
        /* Utilities */
        .center-abs { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }
    </style>
</head>
<body class="h-screen w-full bg-slate-900 text-slate-200 selection:bg-blue-500 selection:text-white">

    <!-- ================= 1. INITIAL MENU ================= -->
    <div id="menu-panel" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-gradient-to-br from-slate-900 to-slate-800 p-6">
        <div class="glass p-8 rounded-3xl shadow-2xl max-w-sm w-full text-center border border-white/10">
            <h1 class="text-3xl font-bold mb-2 text-white tracking-wide"><i class="fa-solid fa-tower-broadcast text-blue-500 mr-2"></i>Connect</h1>
            <p class="text-slate-400 mb-8 text-sm">Choose this device's role</p>

            <div class="flex flex-col gap-4">
                <button onclick="initReceiver()" class="group relative p-5 rounded-2xl bg-blue-600 hover:bg-blue-500 active:scale-95 transition-all text-white shadow-lg shadow-blue-900/20">
                    <div class="flex items-center gap-4 text-left">
                        <div class="bg-white/20 p-3 rounded-xl"><i class="fa-solid fa-desktop text-2xl"></i></div>
                        <div>
                            <div class="font-bold text-lg">Start Receiver</div>
                            <div class="text-blue-200 text-xs">For PC / Tablet</div>
                        </div>
                    </div>
                </button>
                
                <button onclick="showManualConnect()" class="group p-5 rounded-2xl bg-slate-800 hover:bg-slate-700 active:scale-95 border border-slate-700 transition-all text-slate-300">
                    <div class="flex items-center gap-4 text-left">
                        <div class="bg-slate-700 group-hover:bg-slate-600 p-3 rounded-xl"><i class="fa-solid fa-mobile-screen text-2xl"></i></div>
                        <div>
                            <div class="font-bold text-lg">Join as Camera</div>
                            <div class="text-slate-400 text-xs">For Phone</div>
                        </div>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <!-- ================= 2. RECEIVER UI (PC) ================= -->
    <div id="receiver-interface" class="hidden h-full flex flex-row">
        <!-- Video Area -->
        <div class="flex-1 bg-black relative flex items-center justify-center overflow-hidden group">
            <video id="remote-video" autoplay playsinline class="w-full h-full object-contain"></video>
            
            <!-- PC Self-View PIP -->
            <div id="pc-local-preview" class="absolute bottom-6 left-6 w-40 h-28 bg-slate-800 rounded-xl border border-white/10 overflow-hidden shadow-2xl hidden transition-transform hover:scale-105">
                 <video id="pc-video-preview" autoplay playsinline muted class="w-full h-full object-cover transform -scale-x-100"></video>
                 <div class="absolute bottom-0 inset-x-0 bg-gradient-to-t from-black/80 to-transparent p-1 text-[10px] text-center text-white/80">Your Camera</div>
            </div>

            <!-- Connection Overlay -->
            <div id="waiting-overlay" class="absolute inset-0 flex flex-col items-center justify-center bg-slate-900/95 backdrop-blur-sm z-20">
                <div class="glass p-8 rounded-3xl text-center max-w-md border border-blue-500/20 shadow-2xl shadow-blue-900/20">
                    <h2 class="text-2xl font-bold text-white mb-2">Ready to Pair</h2>
                    <p class="text-slate-400 text-sm mb-6">Scan QR or send the link to your phone</p>
                    
                    <div class="bg-white p-3 rounded-2xl inline-block mb-6 shadow-inner">
                        <div id="qrcode"></div>
                    </div>
                    
                    <div class="flex flex-col gap-3">
                        <button onclick="copyLink()" class="w-full py-3 px-6 bg-blue-600 hover:bg-blue-500 text-white rounded-xl font-semibold transition-all flex items-center justify-center gap-2 active:scale-95">
                            <i class="fa-regular fa-copy"></i> Copy Connection Link
                        </button>
                        <div class="text-xs text-slate-500 font-mono">ID: <span id="display-id" class="text-blue-400 select-all">...</span></div>
                    </div>
                </div>
            </div>

            <!-- Loading Spinner -->
            <div id="loading-overlay" class="absolute inset-0 bg-black/90 flex flex-col items-center justify-center z-10 hidden">
                <div class="w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-4"></div>
                <p class="text-blue-400 font-mono animate-pulse">Establishing Secure Stream...</p>
            </div>
            
            <!-- REC Indicator -->
            <div id="rec-indicator" class="absolute top-6 left-6 bg-red-600/90 text-white px-4 py-2 rounded-full text-xs font-bold hidden items-center gap-2 z-30 shadow-lg backdrop-blur">
                <div class="w-2 h-2 bg-white rounded-full animate-pulse"></div> REC <span id="rec-timer" class="font-mono font-normal opacity-90 ml-1">00:00</span>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="w-80 bg-slate-900 border-l border-slate-800 flex flex-col shadow-2xl relative z-40">
            <div class="p-6 border-b border-slate-800 bg-slate-900">
                <h2 class="text-lg font-bold text-white flex items-center gap-2"><i class="fa-solid fa-sliders text-blue-500"></i> Controls</h2>
                <div class="text-xs text-slate-500 mt-1">Status: <span id="connection-status-text" class="text-yellow-500">Idle</span></div>
            </div>

            <div class="flex-1 overflow-y-auto p-6 space-y-8">
                <!-- Audio -->
                <div class="space-y-3">
                    <h3 class="text-[10px] font-bold uppercase text-slate-500 tracking-widest">Audio</h3>
                    <button onclick="toggleAudio()" id="btn-audio" class="w-full py-3 bg-slate-800 hover:bg-slate-700 border border-slate-700 rounded-xl flex items-center justify-center gap-2 text-slate-300 transition-all">
                        <i class="fa-solid fa-volume-xmark" id="icon-audio"></i> <span id="text-audio">Unmute Phone</span>
                    </button>
                </div>

                <!-- Recording -->
                <div class="space-y-3">
                    <h3 class="text-[10px] font-bold uppercase text-slate-500 tracking-widest">Capture</h3>
                    <button id="btn-start-rec" onclick="startRecording()" class="w-full py-3 bg-slate-800 hover:bg-slate-700 border border-slate-700 rounded-xl flex items-center justify-center gap-2 transition-all disabled:opacity-50" disabled>
                        <div class="w-3 h-3 bg-red-500 rounded-full shadow-sm shadow-red-500/50"></div> Start Record
                    </button>
                    <button id="btn-stop-rec" onclick="stopRecording()" class="hidden w-full py-3 bg-red-600 hover:bg-red-500 rounded-xl text-white flex items-center justify-center gap-2 animate-pulse shadow-lg shadow-red-900/20">
                        <i class="fa-solid fa-square"></i> Stop & Save
                    </button>
                </div>

                <!-- Zoom -->
                <div class="space-y-4">
                    <div class="flex justify-between items-center">
                        <h3 class="text-[10px] font-bold uppercase text-slate-500 tracking-widest">Remote Zoom</h3>
                        <span id="zoom-display" class="text-xs font-mono bg-blue-500/10 text-blue-400 px-2 py-1 rounded">1.0x</span>
                    </div>
                    <input type="range" id="sidebar-zoom-slider" min="1" max="5" step="0.1" disabled 
                           oninput="sendZoomCommand(this.value)"
                           class="w-full h-2 bg-slate-800 rounded-lg appearance-none cursor-pointer disabled:opacity-50">
                </div>

                <!-- System -->
                <div class="mt-auto pt-6 border-t border-slate-800 space-y-3">
                     <button onclick="toggleFullScreen()" class="w-full py-2 text-slate-400 hover:text-white text-sm flex items-center gap-2">
                        <i class="fa-solid fa-expand"></i> Fullscreen
                     </button>
                     <button onclick="location.reload()" class="w-full py-2 text-red-400 hover:text-red-300 text-sm flex items-center gap-2">
                        <i class="fa-solid fa-power-off"></i> Disconnect
                     </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ================= 3. SENDER UI (Phone - Simplified) ================= -->
    <!-- LANDING SCREEN (Seen when opening link) -->
    <div id="sender-landing" class="hidden fixed inset-0 bg-slate-900 z-50 flex flex-col items-center justify-center p-6">
        <div class="glass p-8 rounded-3xl shadow-2xl max-w-sm w-full text-center relative z-10 border border-white/10">
            <div class="w-20 h-20 bg-gradient-to-br from-blue-600 to-blue-400 rounded-full flex items-center justify-center mx-auto mb-6 shadow-xl shadow-blue-500/30">
                <i class="fa-solid fa-link text-3xl text-white"></i>
            </div>
            <h2 class="text-2xl font-bold text-white mb-2">Connect to PC?</h2>
            <p class="text-slate-400 text-sm mb-8">This will share your camera and microphone with the connected device.</p>
            
            <button onclick="startOneClickSession()" class="w-full py-4 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-2xl shadow-lg shadow-blue-900/30 active:scale-95 transition-all flex items-center justify-center gap-3">
                <i class="fa-solid fa-video"></i> Connect Camera
            </button>
            
            <div class="mt-6 border-t border-white/10 pt-4">
                <button onclick="startOneClickSession('screen')" class="text-slate-500 text-xs hover:text-white flex items-center justify-center gap-1 w-full py-2">
                    <i class="fa-solid fa-mobile-screen"></i> or share screen
                </button>
            </div>
        </div>
    </div>

    <!-- ACTIVE SESSION (Seen during call) -->
    <div id="sender-active" class="hidden fixed inset-0 bg-black z-50">
        <!-- Incoming PC Video (Full Screen or PIP) -->
        <video id="incoming-pc-video" autoplay playsinline class="w-full h-full object-cover opacity-60"></video>
        
        <!-- Local Phone Preview (Full Screen Overlay) -->
        <div class="absolute inset-0 flex flex-col">
             <div class="flex-1 relative">
                 <!-- Local Vid -->
                 <video id="local-video-preview" autoplay playsinline muted class="w-full h-full object-cover"></video>
                 
                 <!-- Status Badge -->
                 <div class="absolute top-6 left-6 bg-red-600/90 text-white px-3 py-1 rounded-full text-xs font-bold shadow-lg flex items-center gap-2">
                    <div class="w-2 h-2 bg-white rounded-full animate-pulse"></div> LIVE
                 </div>
             </div>
             
             <!-- Controls Bar -->
             <div class="bg-slate-900 p-6 flex justify-around items-center pb-8 rounded-t-3xl shadow-2xl border-t border-white/10">
                 <button onclick="toggleLocalMute(this)" class="p-4 rounded-full bg-slate-800 text-white hover:bg-slate-700 transition-all">
                    <i class="fa-solid fa-microphone"></i>
                 </button>
                 
                 <button onclick="location.reload()" class="p-6 rounded-full bg-red-600 text-white shadow-lg shadow-red-600/40 hover:scale-105 transition-all active:scale-95">
                    <i class="fa-solid fa-phone-slash text-2xl"></i>
                 </button>
                 
                 <button onclick="switchCamera()" class="p-4 rounded-full bg-slate-800 text-white hover:bg-slate-700 transition-all">
                    <i class="fa-solid fa-camera-rotate"></i>
                 </button>
             </div>
        </div>
    </div>

    <!-- Manual Input -->
    <div id="manual-panel" class="hidden fixed inset-0 bg-slate-900/95 backdrop-blur z-50 flex items-center justify-center p-4">
         <div class="glass p-8 rounded-3xl max-w-sm w-full text-center border border-white/10">
            <h3 class="font-bold text-xl mb-6 text-white">Enter Connection ID</h3>
            <input type="text" id="manual-id-input" class="w-full bg-slate-800 border border-slate-600 p-4 rounded-xl text-center text-white text-lg tracking-widest uppercase mb-6 outline-none focus:border-blue-500" placeholder="XXXX">
            <button onclick="connectToId(document.getElementById('manual-id-input').value)" class="w-full bg-blue-600 py-4 rounded-xl text-white font-bold hover:bg-blue-500 transition-all">Connect</button>
            <button onclick="location.reload()" class="mt-6 text-slate-500 text-sm">Cancel</button>
         </div>
    </div>

    <script>
        // --- CONFIG ---
        const peerConfig = { debug: 1 }; 
        let peer = null;
        let targetPeerId = null;
        let senderDataConn = null;
        let receiverDataConn = null;
        let mediaRecorder = null;
        let recordedChunks = [];
        let recInterval = null;
        let localStream = null;

        // --- INIT ---
        window.onload = () => {
            const urlParams = new URLSearchParams(window.location.search);
            const refId = urlParams.get('ref');
            if (refId) {
                // Opened via link -> Show Landing Page directly
                document.getElementById('menu-panel').classList.add('hidden');
                document.getElementById('sender-landing').classList.remove('hidden');
                targetPeerId = refId;
            }
        };

        // --- RECEIVER (PC) ---
        function initReceiver() {
            document.getElementById('menu-panel').classList.add('hidden');
            document.getElementById('receiver-interface').classList.remove('hidden');
            
            const myId = generateId();
            document.getElementById('display-id').innerText = myId;

            const fullUrl = `${window.location.origin}${window.location.pathname}?ref=${myId}`;
            new QRCode(document.getElementById("qrcode"), {
                text: fullUrl, width: 140, height: 140,
                colorDark : "#000000", colorLight : "#ffffff", correctLevel : QRCode.CorrectLevel.L
            });

            peer = new Peer(myId, peerConfig);

            peer.on('call', async (call) => {
                document.getElementById('waiting-overlay').classList.add('hidden');
                document.getElementById('loading-overlay').classList.remove('hidden');

                // Get PC Cam (for return feed)
                try {
                    const pcStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                    document.getElementById('pc-local-preview').classList.remove('hidden');
                    const pcPreview = document.getElementById('pc-video-preview');
                    pcPreview.srcObject = pcStream;
                    pcPreview.volume = 0;
                    call.answer(pcStream);
                } catch (err) {
                    console.warn("PC Cam denied, answering audio-only/recv-only");
                    call.answer();
                }

                call.on('stream', (remoteStream) => {
                    document.getElementById('loading-overlay').classList.add('hidden');
                    document.getElementById('connection-status-text').innerText = "Live";
                    document.getElementById('connection-status-text').className = "text-green-400 font-bold";
                    
                    const video = document.getElementById('remote-video');
                    video.srcObject = remoteStream;
                    video.muted = true; // Auto-play policy
                    video.play().catch(e => console.log(e));

                    document.getElementById('btn-start-rec').disabled = false;
                    enableZoomSlider();
                });
                call.on('close', () => location.reload());
            });

            peer.on('connection', (conn) => {
                receiverDataConn = conn;
                conn.on('data', (data) => {
                    if (data.type === 'init-zoom') updateZoomSlider(data.min, data.max, data.step, data.current);
                });
            });
        }

        function copyLink() {
            const url = `${window.location.origin}${window.location.pathname}?ref=${document.getElementById('display-id').innerText}`;
            navigator.clipboard.writeText(url).then(() => alert("Link Copied! Send it to your phone."));
        }

        // --- SENDER (PHONE) ---
        function showManualConnect() { document.getElementById('manual-panel').classList.remove('hidden'); }
        
        function connectToId(id) {
            if(!id) return;
            targetPeerId = id.trim();
            document.getElementById('manual-panel').classList.add('hidden');
            document.getElementById('menu-panel').classList.add('hidden');
            document.getElementById('sender-landing').classList.remove('hidden');
        }

        // THE "ONE CLICK" FUNCTION
        async function startOneClickSession(mode = 'camera') {
            const btn = document.querySelector('#sender-landing button'); // The big button
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Connecting...';

            try {
                if(!peer) {
                     peer = new Peer(generateId(), peerConfig);
                     await new Promise(resolve => peer.on('open', resolve));
                }

                // 1. Get Media
                if (mode === 'screen') {
                    localStream = await navigator.mediaDevices.getDisplayMedia({ video: { cursor: "always" }, audio: true });
                } else {
                    const constraints = { 
                        video: { facingMode: 'environment', width: {ideal: 1920}, height: {ideal: 1080}, focusMode: 'continuous' },
                        audio: true 
                    };
                    try { localStream = await navigator.mediaDevices.getUserMedia(constraints); } 
                    catch(e) { localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true }); }
                }

                // 2. Setup Zoom Data
                senderDataConn = peer.connect(targetPeerId);
                senderDataConn.on('open', () => {
                     const track = localStream.getVideoTracks()[0];
                     const caps = track.getCapabilities ? track.getCapabilities() : {};
                     const settings = track.getSettings ? track.getSettings() : {};
                     if ('zoom' in caps) {
                         senderDataConn.send({ type: 'init-zoom', min: caps.zoom.min, max: caps.zoom.max, step: caps.zoom.step, current: settings.zoom || 1 });
                     }
                });
                senderDataConn.on('data', async (data) => {
                    if(data.type === 'zoom') {
                        try { await localStream.getVideoTracks()[0].applyConstraints({ advanced: [{ zoom: data.value }] }); } catch(e){}
                    }
                });

                // 3. Call PC
                const call = peer.call(targetPeerId, localStream);
                
                // 4. Handle Return Video (PC Face)
                call.on('stream', (pcRemoteStream) => {
                    const pcVideo = document.getElementById('incoming-pc-video');
                    pcVideo.srcObject = pcRemoteStream;
                });

                // 5. Transition to Active UI
                document.getElementById('sender-landing').classList.add('hidden');
                document.getElementById('sender-active').classList.remove('hidden');
                
                const localPreview = document.getElementById('local-video-preview');
                localPreview.srcObject = localStream;

            } catch (err) {
                alert("Connection Failed: " + err.message);
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        // --- UTILITIES & CONTROLS ---
        
        function toggleAudio() {
            const vid = document.getElementById('remote-video');
            const btn = document.getElementById('btn-audio');
            const icon = document.getElementById('icon-audio');
            const txt = document.getElementById('text-audio');
            
            if(vid.muted) {
                vid.muted = false;
                vid.play();
                btn.classList.replace('bg-slate-800', 'bg-green-600');
                btn.classList.replace('text-slate-300', 'text-white');
                icon.className = "fa-solid fa-volume-high";
                txt.innerText = "Mute Audio";
            } else {
                vid.muted = true;
                btn.classList.replace('bg-green-600', 'bg-slate-800');
                btn.classList.replace('text-white', 'text-slate-300');
                icon.className = "fa-solid fa-volume-xmark";
                txt.innerText = "Unmute Phone";
            }
        }

        function toggleLocalMute(btn) {
            const track = localStream.getAudioTracks()[0];
            if(!track) return;
            track.enabled = !track.enabled;
            if(track.enabled) {
                btn.classList.replace('bg-red-600', 'bg-slate-800');
                btn.innerHTML = '<i class="fa-solid fa-microphone"></i>';
            } else {
                btn.classList.replace('bg-slate-800', 'bg-red-600');
                btn.innerHTML = '<i class="fa-solid fa-microphone-slash"></i>';
            }
        }

        async function switchCamera() {
            // Simple implementation: reload for now as hot-switching tracks is complex with PeerJS stability
            if(confirm("Switching camera requires reconnecting. Continue?")) location.reload();
        }

        function enableZoomSlider() {
            const s = document.getElementById('sidebar-zoom-slider');
            s.disabled = false; s.min = 1; s.max = 5; s.step = 0.1; s.value = 1;
        }
        function updateZoomSlider(min, max, step, current) {
            const s = document.getElementById('sidebar-zoom-slider');
            s.min = min; s.max = max; s.step = step; s.value = current;
        }
        function sendZoomCommand(val) {
            document.getElementById('zoom-display').innerText = val + "x";
            if (receiverDataConn && receiverDataConn.open) receiverDataConn.send({ type: 'zoom', value: val });
        }

        // Recording
        function startRecording() {
            const v = document.getElementById('remote-video');
            if(!v.srcObject) return;
            recordedChunks = [];
            try { mediaRecorder = new MediaRecorder(v.srcObject, { mimeType: 'video/webm;codecs=vp9' }); } 
            catch (e) { mediaRecorder = new MediaRecorder(v.srcObject); }
            mediaRecorder.ondataavailable = e => { if(e.data.size > 0) recordedChunks.push(e.data); };
            mediaRecorder.onstop = saveRecording;
            mediaRecorder.start();
            document.getElementById('btn-start-rec').classList.add('hidden');
            document.getElementById('btn-stop-rec').classList.remove('hidden');
            document.getElementById('rec-indicator').classList.remove('hidden');
            document.getElementById('rec-indicator').style.display = 'flex';
            let sec = 0;
            recInterval = setInterval(() => {
                sec++;
                document.getElementById('rec-timer').innerText = new Date(sec * 1000).toISOString().substr(14, 5);
            }, 1000);
        }
        function stopRecording() {
            if(mediaRecorder) mediaRecorder.stop();
            clearInterval(recInterval);
            document.getElementById('btn-start-rec').classList.remove('hidden');
            document.getElementById('btn-stop-rec').classList.add('hidden');
            document.getElementById('rec-indicator').classList.add('hidden');
        }
        function saveRecording() {
            const blob = new Blob(recordedChunks, { type: 'video/webm' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            document.body.appendChild(a);
            a.style = 'display: none'; a.href = url; a.download = `mirror_${Date.now()}.webm`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function generateId() { return Math.floor(Math.random()*16777215).toString(16).slice(0,4).toUpperCase(); }
        function toggleFullScreen() {
            if (!document.fullscreenElement) document.documentElement.requestFullscreen(); else document.exitFullscreen();
        }
    </script>
</body>
</html>
